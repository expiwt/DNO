# DNO
This repository presents an implementation of DNO method used in an university qualification work. 

# DNO (Diffeomorphic Neural Operator) для УрЧП на разных геометриях

Репозиторий содержит пайплайн для масштабирования нейронных операторов на семейства 2D-доменов с разной геометрией и топологией, включая домены с внутренней границей (“дыркой”), через идею диффеоморфного отображения в универсальный домен.

Целевой пример: стационарное 2D уравнение Дарси на физическом домене Ωp:
\[
-\nabla \cdot (c(x,y)\nabla u(x,y)) = F(x,y), \quad u|_{\partial \Omega_p}=0
\]
Вход: поле коэффициента проницаемости `c(x,y)` + описание геометрии.  
Выход: поле решения `u(x,y)`.

Ключевой инженерный результат: поля и геометрия приводятся к представлению на регулярной сетке **128×128**, после чего обучается нейрооператор и переносится на новые домены (в т.ч. с “дыркой”).

---

## Идея метода

Классический FNO хорошо работает, когда домен фиксирован и данные заданы на регулярной сетке. При смене геометрии качество падает и часто требуется переобучение.

Здесь используется идея диффеоморфизма:
1. Строится отображение из физического домена Ωp в **универсальный домен** (например, квадрат [0,1]×[0,1], а для “дырки” — квадрат с фиксированной внутренней окружностью).
2. Поля (геометрия/координаты/коэффициенты/решение) интерполируются на общую регулярную сетку 128×128 в универсальном пространстве.
3. Нейрооператор обучается в унифицированном представлении и применяется к новым геометриям через соответствующее отображение.

---

## Структура репозитория

Верхний уровень:
- `train_final.py` — обучение/запуск основного эксперимента для доменов **без дырок**.
- `train_hole_impr.py` — обучение/эксперименты для доменов **с дыркой** (маскирование, стабильность, улучшения).
- `test_hole.py`, `quad_test.py` — тестирование обученной модели на других геометриях.
- `Loss_function.py` — функции потерь.
- `loss/` — сохранённые графики/визуализации лоссов.

Датасеты / генерация / маппинг:
- `sq_art_matlab/` — пайплайн генерации четырехугольников без дырок (Python + MATLAB):
  - генерация параметров геометрии, OBJ, построение диффеоморфизма, FEM-решение в MATLAB PDE Toolbox, интерполяция на 128×128 и сохранение CSV.
- `pentagon/` — пример/пайплайн для пятиугольников (CSV + OBJ.
- `sq_w_hole/` — пайплайн для четырёхугольников с дыркой:
  - `create_dif_map/` — построение диффеоморфизма и подготовка `x_data.csv`, `y_data.csv` (train/test),
  - `generate_dataset/` — пакетная генерация решений (FEM в Firedrake) и сохранение `C.csv`, `U.csv`,
  - `*_part_obj/` и `*.msh` — геометрии/сетки.
- `seven_w_h/` — аналогичный пайплайн для “семиугольников с дыркой” (как тест обобщения на новую геометрию).

---

## Данные: формат и соглашения

Во всех вариантах (без дырок / с дыркой) данные приводятся к одному “сеточному” формату:

- `x_data.csv`, `y_data.csv`
  - по одной строке на объект/геометрию,
  - каждая строка — это “развёрнутая” регулярная сетка 128×128 (длина 16384),
  - значения — координаты точки в физическом домене (или NaN для невалидных точек в случае “дырки”).
- `C.csv`
  - поле коэффициента `c(x,y)` на той же регулярной сетке (развёрнуто в строку).
- `U.csv`
  - поле решения `u(x,y)` на той же регулярной сетке.

### Домены без дырок: кодирование геометрии
Для “граничного эффекта” используется дополнительный канал `b` — рамка из единиц по краю и нулей внутри, чтобы модель видела границу в регулярном представлении.

Вход модели часто формируется как 4 канала:
- `[C, x, y, b]`

### Домены с дыркой: маска валидной области
Для домена с дыркой часть регулярной сетки попадает “внутрь дырки” — эти точки невалидны.

Практическое решение:
- в `x_data/y_data` внутри дырки стоят `NaN`,
- строится `mask` валидности (`1` — валидно, `0` — дырка),
- `NaN` заменяются на 0 в численных тензорах, но дырка остаётся “видимой” через отдельный канал.

Вход модели:
- `[C, x, y, mask]`

Выход `U` и лосс считаются только по валидным точкам (через умножение на mask).

---

## Пайплайн без дырок (квадраты/пятиугольники)

Типичный сценарий:
1. **Генерация геометрий** (Python + Gmsh): параметры → OBJ/сетка.
2. **Построение диффеоморфизма** (Python): отображение Ωp → [0,1]×[0,1], формирование `x_data/y_data` на 128×128.
3. **Генерация коэффициентов и решение PDE** (MATLAB):
   - генерация `c(x,y)` (параметрическая формула + масштабы),
   - решение FEM в MATLAB PDE Toolbox,
   - интерполяция решения на регулярную сетку через `griddata(..., 'cubic')`.
4. Сохранение `C.csv`, `U.csv`, `x_data.csv`, `y_data.csv`.

---

## Пайплайн с дыркой (Firedrake + маскирование)

1. **Генерация геометрий с дыркой**:
   - 4-угольники: генерация набора геометрий и `.msh`,
   - 7-угольники: отдельный генератор “seven with hole”.
2. **Построение отображения в универсальный домен с дыркой**:
   - универсальный домен: квадрат + круглая дырка фиксированного радиуса (0.1) в центре,
   - внешняя и внутренняя границы “якорятся” опорными точками,
   - отображение строится решением дискретной задачи Лапласа на сетке,
   - затем формируются `x_data/y_data` на 128×128 (с NaN в дырке).
3. **Решение PDE в Firedrake**:
   - решается вариационная постановка для Дарси на каждой `.msh`-геометрии,
   - значения `u` и `c` сохраняются на регулярной сетке, невалидные точки остаются NaN/0 + маска.

Для батчевой генерации используются `run_all.sh` (партиями, чтобы можно было перезапускать диапазоны).

---

## Обучение

### Без дырок
- Архитектура: 2D FNO-подобный нейронный оператор на регулярной сетке.
- Лосс: относительная Lp-ошибка (LpLoss).
- Типовые гиперпараметры (пример): `modes=16`, `width=32`, `batch=8`, `epochs=150`, `lr=1e-3`, `StepLR(step_size=20, gamma=0.7)`.
- Артефакты:
  - чекпоинты (каждые N эпох),
  - CSV с train/test loss,
  - графики лосса в `loss/`.

### Режим с дыркой
- Вводится `mask` и masking в loss: ошибка считается только по валидной области.
- Возможен grid search по `batch/modes/width/lr/scheduler` (см. `train_hole_impr.py` и связанные скрипты).


